# Coke魔方财务微信实名认证插件

## 授权说明

通用永久授权码为：2021967063

## 许可证

本插件采用商业许可证，允许用于商业项目，但必须保留原作者署名信息。未经许可不得去除或更改代码中的版权声明。

## 项目概述

Coke 微信实名认证插件是一款专为魔方财务系统设计的实名认证解决方案，利用腾讯云人脸识别技术，实现用户身份验证功能。该插件允许用户通过微信进行便捷的个人实名认证，整个认证过程简单、安全、可靠。

## 安装说明

这是一个魔方财务系统的实名认证插件，安装步骤如下：

1. 将插件解压到财务系统的插件目录：`public/plugins/certification`
2. 将项目文件夹重命名为 `wechat_coke`
3. 在魔方财务系统后台启用插件
4. 配置腾讯云相关参数

## 功能特性

### 主要功能
- **微信个人实名认证**：通过微信扫描二维码进行实名认证
- **腾讯云人脸识别**：集成腾讯云先进的人脸识别技术
- **移动设备优化**：针对移动设备的用户体验进行了优化
- **微信H5环境检测**：自动检测是否在微信环境中并相应调整流程
- **渐进式延迟轮询**：优化认证状态查询效率

### 技术特性
- **渐进式延迟策略**：认证状态轮询采用递增延迟（1s、2s、3s、5s、10s），平衡响应速度与系统负载
- **设备环境检测**：智能识别移动设备和微信环境，提供最优用户体验
- **数据库适配**：自动扩展认证表字段以存储认证凭证

## 架构设计

### 文件结构
```
├── WechatCokePlugin.php          # 插件主入口类
├── config/
│   ├── config.php               # 插件基础配置
│   └── QcloudFaceidProvider.php # 腾讯云人脸核身服务提供商
├── logic/
│   ├── WechatCoke.php           # 微信认证业务逻辑
│   └── QcloudFaceid.php         # 腾讯云API实现
└── config.php                   # 配置参数定义
```

### 核心组件

#### WechatCokePlugin
插件主类，负责：
- 插件安装/卸载过程管理
- 个人实名认证流程控制
- 移动设备和微信环境检测
- 二维码生成和展示

#### WechatCoke
业务逻辑类，负责：
- 获取检测认证信息
- 查询认证状态
- 实现渐进式延迟轮询机制

#### QcloudFaceid
腾讯云API实现类，负责：
- 与腾讯云人脸识别API通信
- 生成认证令牌
- 获取认证结果
- 实现腾讯云TC3-HMAC-SHA256签名算法

## 配置说明

### 必需配置项
- `RuleId`: 业务流程ID（腾讯云控制台获取）
- `SecretId`: 腾讯云SecretId
- `SecretKey`: 腾讯云SecretKey
- `callback_domain`: 回调域名

### 可选配置项
- `amount`: 支付金额
- `free`: 免费认证次数
- `return_url`: 返回URL
- `biz_code`: 业务代码
- `debug`: 调试模式开关

## 工作流程

### 认证流程
1. 用户输入姓名和身份证号
2. 系统向腾讯云请求认证令牌
3. 生成微信二维码供用户扫描
4. 用户在微信中完成人脸识别
5. 系统轮询获取认证结果
6. 返回认证状态给用户

### 移动端优化
- 自动检测用户设备类型和访问环境
- 非微信环境的移动设备显示"免扫码"按钮
- 微信环境内直接跳转认证页面
- 避免中间步骤，提升用户体验

## 安全措施

### 授权验证
- 回调域名不能为空的安全要求
- 对关键配置进行运行时验证

### 错误处理
- 对不可恢复的错误提前终止轮询
- 提供明确的错误信息提示
- 区分可恢复和不可恢复错误类型

## 技术栈

- PHP 7.x+
- 腾讯云人脸识别API
- 微信开放平台
- Guzzle HTTP客户端
- 二维码生成库

## 社区支持

如果您对此插件有任何问题或建议，欢迎加入我们的交流群：

![QQ群二维码](./doc/img/qrcode_1770042108894.jpg)

如果您觉得此插件对您有帮助，欢迎赞赏支持：

![赞赏码](./doc/img/mm_reward_qrcode_1768916104192.png)

## 注意事项

1. 必须配置有效的腾讯云凭证才能正常使用
2. 回调域名不能为空，否则无法接收认证结果
3. 仅支持在微信环境中完成最终认证
4. 认证有效时间为3分钟，超时需重新开始
5. 需要网络访问腾讯云API服务